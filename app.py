# -*- coding: utf-8 -*-
"""app.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1A6nYUyOabSo3lhooiVweSj0sbW2zrhqa
"""

import streamlit as st
import pandas as pd
from datetime import datetime

# Cargar datos limpios
@st.cache_data
def cargar_datos():
    try:
        df = pd.read_csv("datos_limpios.csv", dtype={"CEDULA": str})
        df['FECHA SIMPLE'] = pd.to_datetime(df['FECHA SIMPLE'], errors='coerce')
        return df
    except Exception as e:
        st.error(f"‚ùå Error al cargar los datos: {str(e)}")
        return None

df = cargar_datos()

# Funci√≥n para consultar por c√©dula
def consultar_por_cedula(cedula):
    if df is None:
        return None, "Datos no disponibles."

    try:
        resultado = df[df['CEDULA'].str.strip() == cedula.strip()]
        if resultado.empty:
            return None, "No se encontr√≥ ning√∫n estudiante con esa c√©dula."

        info = resultado.iloc[0]
        hoy = datetime.now().date()
        fecha_defensa = info['FECHA SIMPLE'].date() if pd.notna(info['FECHA SIMPLE']) else None

        datos = {
            "nombre": info.get("APELLIDOS Y NOMBRES", "No disponible"),
            "opcion": info.get("OPCION DE TITULACI√ìN EX. COM./TIC/TT", "No especificada"),
            "fecha": info['FECHA SIMPLE'].strftime('%d/%m/%Y') if fecha_defensa else "No programado",
            "hora": info.get("HORA", "No especificada"),
            "enlace": info.get("ENLACES", "#"),
            "hoy": fecha_defensa == hoy if fecha_defensa else False
        }

        return datos, None

    except Exception as e:
        return None, f"Error al procesar la consulta: {str(e)}"

# Interfaz de usuario
def main():
    st.title("üéì Consulta de Defensas de Titulaci√≥n UTPL")
    st.markdown("Ingrese su n√∫mero de c√©dula para conocer sus detalles de defensa:")

    cedula = st.text_input("C√©dula:", placeholder="Ejemplo: 0987654321")

    if st.button("Consultar", type="primary"):
        if not cedula or not cedula.isdigit():
            st.warning("Por favor ingrese una c√©dula v√°lida (solo n√∫meros).")
        else:
            with st.spinner("Buscando informaci√≥n..."):
                datos, error = consultar_por_cedula(cedula)

                if error:
                    st.error(error)
                else:
                    st.success(f"‚úÖ Informaci√≥n encontrada para: **{datos['nombre']}**")
                    st.write(f"**Opci√≥n de titulaci√≥n:** {datos['opcion']}")

                    if datos["hoy"]:
                        st.balloons()
                        st.warning("‚ö†Ô∏è ¬°Tienes defensa HOY!")
                        st.write(f"**Fecha:** {datos['fecha']}")
                        st.write(f"**Hora:** {datos['hora']}")
                        st.markdown(f"[üîó Unirse a la reuni√≥n]({datos['enlace']})")
                    else:
                        st.info(f"üìÖ Pr√≥ximo evento: {datos['fecha']} - {datos['hora']}")

    st.markdown("---")
    st.caption("¬© 2025 | Sistema de Consulta de Defensas | UTPL")

if __name__ == "__main__":
    main()
